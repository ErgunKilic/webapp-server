{# vim: set ft=jinja: -#}
# Nginx configuration
# -------------------
# vim: set ft=nginx:
# for: {{ groupname }}
#
server {
    listen 80;
    server_name {{ environ.HOSTNAME }};

    root /var/www/public;

    index index.php index.html index.htm;

    # Logs
    access_log /var/www/logs/access.log;
    error_log /var/www/logs/error.log;

    location / {
        try_files $uri $uri/ /index.php$is_args$args;
    }

    location ~ \.php$ {
        # Variables coming from the environment.
        # See main nginx configuration.
        set_by_lua $env_MYSQL_HOST 'return os.getenv("MYSQL_PORT_3306_TCP_ADDR")';
        set_by_lua $env_MYSQL_PORT 'return os.getenv("MYSQL_PORT_3306_TCP_PORT")';
        set_by_lua $env_MYSQL_DATABASE 'return os.getenv("MYSQL_DATABASE")';
        set_by_lua $env_MYSQL_USERNAME 'return os.getenv("MYSQL_USERNAME")';
        set_by_lua $env_MYSQL_PASSWORD 'return os.getenv("MYSQL_PASSWORD")';

        set_by_lua $env_POSTGRES_HOST 'return os.getenv("POSTGRES_PORT_5432_TCP_ADDR")';
        set_by_lua $env_POSTGRES_PORT 'return os.getenv("POSTGRES_PORT_5432_TCP_PORT")';
        set_by_lua $env_POSTGRES_DATABASE 'return os.getenv("POSTGRES_DATABASE")';
        set_by_lua $env_POSTGRES_USERNAME 'return os.getenv("POSTGRES_USERNAME")';
        set_by_lua $env_POSTGRES_PASSWORD 'return os.getenv("POSTGRES_PASSWORD")';

        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php5-fpm.sock;

        fastcgi_param MYSQL_HOST $env_MYSQL_HOST;
        fastcgi_param MYSQL_PORT $env_MYSQL_PORT;
        fastcgi_param MYSQL_DATABASE $env_MYSQL_DATABASE;
        fastcgi_param MYSQL_USERNAME $env_MYSQL_USERNAME;
        fastcgi_param MYSQL_PASSWORD $env_MYSQL_PASSWORD;

        fastcgi_param POSTGRES_HOST $env_POSTGRES_HOST;
        fastcgi_param POSTGRES_PORT $env_POSTGRES_PORT;
        fastcgi_param POSTGRES_DATABASE $env_POSTGRES_DATABASE;
        fastcgi_param POSTGRES_USERNAME $env_POSTGRES_USERNAME;
        fastcgi_param POSTGRES_PASSWORD $env_POSTGRES_PASSWORD;
    }
}
